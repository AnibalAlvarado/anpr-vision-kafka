name: anprvision-kafka-prod
version: "3.9"

services:

  kafka-prod:
    image: bitnamilegacy/kafka:4.0.0
    container_name: kafka-prod

    ports:
      - "${KAFKA_PORT_INTERNAL}:${KAFKA_PORT_INTERNAL}"
      - "${KAFKA_PORT_EXTERNAL}:${KAFKA_PORT_EXTERNAL}"

    environment:
      # ===========================
      # âš ï¸ CLUSTER ID FIJO (OBLIGATORIO)
      # ===========================
      KAFKA_CLUSTER_ID: "${KAFKA_CLUSTER_ID}"

      KAFKA_CFG_NODE_ID: 1
      KAFKA_CFG_PROCESS_ROLES: broker,controller

      # ===========================
      # LISTENERS (UNA SOLA LÃNEA)
      # ===========================
      KAFKA_CFG_LISTENERS: "INTERNAL://:${KAFKA_PORT_INTERNAL},EXTERNAL://:${KAFKA_PORT_EXTERNAL},CONTROLLER://:9093"

      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: "INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT,CONTROLLER:PLAINTEXT"

      # ===========================
      # QUORUM
      # ===========================
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: "1@kafka-prod:9093"

      # ===========================
      # ADVERTISED LISTENERS (UNA SOLA LÃNEA)
      # ===========================
      KAFKA_CFG_ADVERTISED_LISTENERS: "INTERNAL://kafka-prod:${KAFKA_PORT_INTERNAL},EXTERNAL://${KAFKA_TAILSCALE_IP}:${KAFKA_PORT_EXTERNAL}"

      # Extras
      ALLOW_PLAINTEXT_LISTENER: "yes"
      KAFKA_CFG_LOG_RETENTION_HOURS: "${KAFKA_LOG_RETENTION_HOURS}"
      KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE: "${KAFKA_AUTO_CREATE_TOPICS_ENABLE}"

    volumes:
      - kafka_data_prod:/bitnami/kafka

    networks:
      - anpr-net-prod

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "bash", "-c", "nc -z localhost ${KAFKA_PORT_INTERNAL} || nc -z localhost ${KAFKA_PORT_EXTERNAL}"]
      interval: 10s
      timeout: 5s
      retries: 12

  kafka-init-prod:
    image: bitnamilegacy/kafka:4.0.0
    container_name: kafka-init-prod
    depends_on:
      - kafka-prod
    env_file:
      - .env
    entrypoint: >
      bash -c "
        echo 'â³ Esperando Kafka PROD...';
        for i in $(seq 1 60); do
          /opt/bitnami/kafka/bin/kafka-topics.sh --bootstrap-server ${KAFKA_BROKER} --list >/dev/null 2>&1 && { echo 'âœ… Kafka listo'; break; }
          sleep 1;
        done;
        echo 'ðŸ“¦ Creando tÃ³picos para PROD...';
        /opt/bitnami/kafka/bin/kafka-topics.sh --create --bootstrap-server ${KAFKA_BROKER} --replication-factor ${KAFKA_REPLICATION_FACTOR} --partitions ${KAFKA_NUM_PARTITIONS} --topic ${KAFKA_TOPIC_PLATE} --if-not-exists;
        /opt/bitnami/kafka/bin/kafka-topics.sh --create --bootstrap-server ${KAFKA_BROKER} --replication-factor ${KAFKA_REPLICATION_FACTOR} --partitions ${KAFKA_NUM_PARTITIONS} --topic ${KAFKA_TOPIC_CAMERAS} --if-not-exists;
        echo 'âœ… kafka-init-prod completado.';
      "
    networks:
      - anpr-net-prod
    restart: "no"

  kafka-ui-prod:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui-prod
    ports:
      - "${KAFKA_UI_PORT}:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: "prod"
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: "kafka-prod:${KAFKA_PORT_INTERNAL}"
    depends_on:
      - kafka-prod
    networks:
      - anpr-net-prod
    restart: unless-stopped

volumes:
  kafka_data_prod:

networks:
  anpr-net-prod:
    external: true
